<!-- Botón menú hamburguesa -->
<button class="btn btn-dark position-fixed top-0 start-0 m-3 z-3 shadow-sm rounded-circle" 
        (click)="menuOpen = !menuOpen">
  <i class="bi bi-list fs-4"></i>
</button>

<!-- Sidebar -->
<div class="offcanvas offcanvas-start text-bg-dark" [class.show]="menuOpen" tabindex="-1" style="visibility: visible;" 
     (click)="menuOpen = false">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title">Menú</h5>
    <button type="button" class="btn-close btn-close-white" (click)="menuOpen = false"></button>
  </div>
  <div class="offcanvas-body">
    <ul class="nav flex-column">
      <li class="nav-item mb-2">
        <a routerLink="/crear-hamburguesa" class="nav-link text-white" (click)="menuOpen = false">
          <i class="bi bi-plus-circle me-2"></i> Crear Hamburguesa
        </a>
      </li>
      <li class="nav-item">
        <a routerLink="/verPedidos" class="nav-link text-white" (click)="menuOpen = false">
          <i class="bi bi-receipt me-2"></i> Ver Pedidos
        </a>
      </li>
    </ul>
  </div>
</div>

<!-- Formulario principal -->
<div class="container py-5">
  <div class="card shadow-sm border-0">
    <div class="card-body">
      <h2 class="text-center mb-4 fw-bold text-dark">Agregar Hamburguesa</h2>

      <form [formGroup]="form" (ngSubmit)="onSubmit()" novalidate class="row g-4">

        <!-- Nombre -->
        <div class="col-md-6">
          <label for="nombre" class="form-label fw-semibold">Nombre</label>
          <input id="nombre" type="text" class="form-control" formControlName="nombre"
                 placeholder="Ej: Hamburguesa Clásica" />
          <div *ngIf="f.nombre?.touched && f.nombre?.invalid" class="text-danger small mt-1">
            <span *ngIf="f.nombre?.errors?.['required']">El nombre es obligatorio.</span>
            <span *ngIf="f.nombre?.errors?.['minlength']">Mínimo 3 caracteres.</span>
          </div>
        </div>

        <!-- Descripción -->
        <div class="col-md-6">
          <label for="descripcion" class="form-label fw-semibold">Descripción</label>
          <input id="descripcion" type="text" class="form-control" formControlName="descripcion"
                 placeholder="Ej: cheddar, panceta, cebolla..." />
        </div>

        <!-- Precio -->
        <div class="col-md-6">
          <label for="precio" class="form-label fw-semibold">Precio</label>
          <input id="precio" type="number" class="form-control" formControlName="precio"
                 placeholder="Ej: 12000" />
        </div>

        <!-- Imagen -->
        <div class="col-md-6">
          <label for="imagenUrl" class="form-label fw-semibold">Imagen (URL)</label>
          <input id="imagenUrl" type="url" class="form-control" formControlName="imagenUrl"
                 placeholder="https://..." />
          <div *ngIf="f.imagenUrl?.touched && f.imagenUrl?.invalid" class="text-danger small mt-1">
            <span *ngIf="f.imagenUrl?.errors?.['pattern']">Debe comenzar con http(s)://</span>
          </div>
        </div>

        <!-- Ingredientes -->
        <div class="col-12" formArrayName="listIngredientes">
          <label class="form-label fw-semibold">Ingredientes</label>

          <div *ngFor="let ing of ingredientes.controls; let i = index" [formGroupName]="i" class="row g-2 align-items-center mb-2">

            <div class="col-md-4">
              <input type="text" class="form-control" formControlName="nombre" placeholder="Nombre" />
            </div>

            <div class="col-md-2" *ngIf="ing.get('tipo')?.value === 'Cantidad'">
              <input type="number" min="0" class="form-control" formControlName="cantidad" placeholder="Cant." />
            </div>

            <div class="col-md-2" *ngIf="ing.get('tipo')?.value !== 'Fijo'">
              <input type="number" step="0.01" min="0" class="form-control" formControlName="precio" placeholder="Precio" />
            </div>

            <div class="col-md-3 tipo-selector">
              <div class="btn-group w-100" role="group">
                <input type="radio" class="btn-check" formControlName="tipo" value="Fijo" id="tipoFijo{{i}}">
                <label class="btn btn-outline-secondary" for="tipoFijo{{i}}">Fijo</label>

                <input type="radio" class="btn-check" formControlName="tipo" value="Cantidad" id="tipoCant{{i}}">
                <label class="btn btn-outline-secondary" for="tipoCant{{i}}">Cantidad</label>

                <input type="radio" class="btn-check" formControlName="tipo" value="Carne" id="tipoCarne{{i}}">
                <label class="btn btn-outline-secondary" for="tipoCarne{{i}}">Carne</label>
              </div>
            </div>

            <div class="col-md-1 text-center">
              <button type="button" class="btn btn-outline-danger btn-sm" 
                      (click)="removeIngrediente(i)" [disabled]="ingredientes.length === 1">
                <i class="bi bi-trash"></i>
              </button>
            </div>
          </div>

          <button type="button" class="btn btn-outline-primary mt-3 w-100" (click)="addIngrediente()">
            <i class="bi bi-plus-circle me-1"></i> Agregar ingrediente
          </button>
        </div>

        <!-- Botón Guardar -->
        <div class="col-12 text-center mt-4">
          <button type="submit" class="btn btn-success px-5 py-2 fw-bold" [disabled]="form.invalid">
            Guardar
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Vista previa -->
  <div class="card mt-4 shadow-sm border-0" *ngIf="form.value.nombre || form.value.precio || form.value.imagenUrl || hasIngredientes()">
    <div class="card-body d-flex align-items-center">
      <img *ngIf="form.value.imagenUrl" [src]="form.value.imagenUrl!" alt="preview" 
           class="rounded me-3" width="100" height="100" (error)="onImageError()" />
      <div>
        <h5 class="fw-bold mb-1">{{ form.value.nombre || 'Sin nombre' }}</h5>
        <p class="text-success fw-semibold mb-2" *ngIf="form.value.precio">
          {{ form.value.precio | currency:'ARS' }}
        </p>
        <ul class="mb-0 small">
          <ng-container *ngFor="let ing of ingredientesPreview">
            <li *ngIf="ing?.nombre">
              <span *ngIf="ing.tipo === 'Fijo'">✔ {{ ing.nombre }}</span>
              <span *ngIf="ing.tipo === 'Cantidad'">{{ ing?.cantidad }} x {{ ing.nombre }}</span>
              <span *ngIf="ing?.precio"> ({{ ing.precio | currency:'ARS' }})</span>
            </li>
          </ng-container>
        </ul>
      </div>
    </div>
  </div>
</div>

<div class="modal-backdrop fade show" *ngIf="showSuccessModal"></div>
<div class="modal fade show d-block" *ngIf="showSuccessModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow">
      <div class="modal-body text-center p-5">
        <div class="text-success display-3 mb-3">
          <i class="bi bi-check-circle-fill"></i>
        </div>
        <h4 class="fw-bold mb-2">¡Hamburguesa creada con éxito!</h4>
        <p class="text-muted mb-4">Tu hamburguesa fue agregada correctamente al menú</p>
        <button class="btn btn-success px-4" (click)="showSuccessModal = false">Aceptar</button>
      </div>
    </div>
  </div>
</div>

<div class="modal-backdrop fade show" *ngIf="showErrorModal"></div>
<div class="modal fade show d-block" *ngIf="showErrorModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow">
      <div class="modal-body text-center p-5">
        <div class="text-danger display-3 mb-3">
          <i class="bi bi-x-circle-fill"></i>
        </div>
        <h4 class="fw-bold mb-2">Ocurrió un error</h4>
        <p class="text-muted mb-4">{{ errorMessage || 'No se pudo guardar la hamburguesa.' }}</p>
        <button class="btn btn-danger px-4" (click)="showErrorModal = false">Cerrar</button>
      </div>
    </div>
  </div>
</div>

